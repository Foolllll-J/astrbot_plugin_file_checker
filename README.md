# File Checker - 群文件有效性检查

一个为 [AstrBot](https://astrbot.app) 设计的、功能强大的文件检查插件。它可以精准检查文件是否有效，并能立即提供内容预览，在一段时间后对有效文件进行二次复核，以确保文件的可用性。

## ✨ 功能

* **延时失效复核**: 对初步检查完全有效的文件，在用户设定的延时后，进行第二次检查，专门捕获一段时间后失效的文件。
* **静默成功，失败提醒**: 延时复核成功后会**保持沉默**，避免打扰；只在文件确认已失效时，才会发送通知。
* **媒体文件自动转换**: 可自动检测上传的视频（MP4）和图片（JPG/PNG）文件，并以媒体形式重新发送。转换成功后 30 分钟删除群文件和本地缓存。
* **合并转发**: 当文本预览或回复消息过长时，自动将内容转为合并转发形式发送，避免刷屏，优化群聊体验。
* **文本识别**: 集成 `chardet` 库，能自动识别并正确处理包括 `UTF-8`, `GBK`, `Big5` (繁體中文) 在内的多种文本编码格式。
* **压缩文件处理**: 对于**已失效的文件**，插件会自动将其加密压缩为 `.zip` 格式并重新发送。这个新文件将接替原文件，进入延时复核队列。同时，插件也具备解压多种格式压缩包（ZIP/7Z/TAR/GZ/BZ2/XZ 等）并预览其中文本文件（支持30+种格式）的能力，若压缩包内无文本文件，则自动展示文件结构列表。
* **重复文件检测**: 具有重复文件检测功能，能自动识别已上传过的文件，并提供文件的历史检查记录，避免重复上传。

---

## 🚀 安装

1. **进入容器安装依赖**：如果你的 AstrBot 运行在 Docker 容器中，请先进入容器内部。
   
   ```bash
   docker ps  # 找到你的 AstrBot 容器ID
   docker exec -it <容器ID> bash  # 或者 sh
   ```
   
   然后在容器内安装 `zip` 依赖库：
   
   ```bash
   # 对于 Debian/Ubuntu 系统
   apt-get update && apt-get install zip p7zip-full
   # 对于 Alpine Linux 系统
   apk add zip p7zip
   ```
2. 下载本仓库。
3. 将整个 `astrbot_plugin_file_checker` 文件夹放入 `astrbot` 的 `plugins` 目录中。
4. 重启 AstrBot。

---

## ⚙️ 配置

首次加载后，请在 AstrBot 后台 -> 插件 页面找到本插件进行设置。所有配置项都有详细的说明和提示。

---

## 💡 使用

本插件采用两阶段工作模式：

#### 阶段一：即时预览与诊断

当白名单内的群聊有成员发送文件时，插件会在等待“预检延时”后，立即进行一次检查。

* **如果文件已存在**: 插件将直接回复已有的历史记录，并结束流程。
* **如果文件在群文件中有效**:
  * 机器人会**引用回复**一条成功通知。
  * 如果文件是文本或压缩包（ZIP/7Z/TAR 等），通知中还会附带**内容预览**或**文件结构**。
  * 同时，此文件会被加入**延时复核队列**。
* **如果文件在群文件中失效**:
  * 机器人会**引用回复**一条**特殊警告**，例如：“⚠️ 您发送的文件已失效”。
  * 如果失效文件的后缀包含于 `repack_file_extensions` ，会将其重新打包成加密 ZIP 并发送。这个新文件将接替原文件，进入延时复核队列。

#### 阶段二：延时复核

* 只有在**第一阶段完全成功**的文件，或者**被重新打包的新文件**，才会进入此阶段。
* 等待“复核延时”结束后，插件会再次通过**群文件系统API**检查该文件。
* 如果此时文件**依然有效**，机器人会**保持沉默**，不发送任何消息。
* 如果此时文件**已经失效**，机器人会**再次引用回复**原始消息，并发送“经xx秒后复核，已失效”的通知。

---

## 📝 版本记录

* **v1.7**
  * 新增 **图片文件自动转换** 功能。
  * 新增 `enable_auto_convert_image` 配置项。
  * 新增 **多格式压缩包支持**，现在可以预览 ZIP、7Z、TAR 等多种压缩格式。
  * 优化 **文本预览支持**，新增支持 30+ 种文本格式。
* **v1.6**
  * 新增 **视频文件自动转换** 功能，可将上传的 MP4 视频文件自动以视频形式重新发送。
  * 新增 `auto_convert_video_threshold_mb` 配置项，可设置视频文件自动转换的大小阈值。
  * 新增 **失效文件自动删除** 功能，检查后确认失效的原文件将被自动删除。
* **v1.5**
  * 新增 `file_size_threshold_mb` 配置项，可设置文件大小阈值，超过此值的文件将完全跳过处理。
  * 优化自动补档功能，将 `enable_repack_on_failure` 配置项改为 `repack_file_extensions`，支持配置多种文件后缀。
  * 优化 ZIP 预览功能，当压缩包内无 `.txt` 文件时，自动展示文件结构列表。
* **v1.4**
  * 新增 **重复文件检测** 功能，可识别已上传过的文件，避免重复。
  * 新增 `enable_duplicate_check` 配置项。
* **v1.3**
  * 新增 **压缩文件处理** 功能。对于已失效的文件，插件可将其加密压缩成 `.zip` 并重新发送，同时支持解压压缩包进行预览。
  * 新增 `enable_repack_on_failure`, `repack_zip_password`, `enable_zip_preview`, `default_zip_password` 配置项。
* **v1.2**
  * 新增 **长消息自动合并转发** 功能及对应的 `forward_threshold` 配置项，避免长文本预览刷屏。
  * 优化 **文件识别逻辑**，完全依赖 `file_id` 进行追踪，解决了在极端情况下可能出现的识别混淆问题。
* **v1.1**
  * 新增 **即时内容预览** 功能，可在回复中显示文本文件开头内容。
  * 新增 **阶段一预检延时** 和 **文本预览长度** 的自定义配置项。
  * 优化 阶段一检查逻辑。
* **v1.0**
  * 插件首次发布。
  * 实现两阶段检查（即时检查 + 延时复核）核心功能。
  * 支持群聊白名单、成功通知开关、复核延时等基础配置。

## ❓ 常见问题 (FAQ)

### **Q: 插件突然不工作了，或者启动时报错，我该怎么办？**

**A:** 在遇到任何插件运行错误或功能异常时，可按照以下步骤尝试解决：

1. **重载插件**
2. **重启 AstrBot**
3. **重启 NapCat**

---

## ❤️ 支持

* [AstrBot 帮助文档](https://astrbot.app)
* 如果您在使用中遇到问题，欢迎在本仓库提交 [Issue](https://github.com/Foolllll-J/astrbot_plugin_file_checker/issues)。

